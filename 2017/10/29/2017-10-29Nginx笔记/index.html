

<html lang="zh-CN">
  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=2.0, user-scalable=yes" />

  <meta http-equiv="Cache-Control" content="no-transform" />
  <meta http-equiv="Cache-Control" content="no-siteapp" />

  <meta name="theme-color" content="#42dbbc" />
  <meta name="msapplication-navbutton-color" content="#f8f5ec" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec" />

  
  
  
    <link rel="shortcut icon" type="image/x-icon" href="/images/favicon.ico" />
  

  <title>Nginx 笔记 | 舊時光</title>


  

  <link rel="stylesheet" href="/css/atom-one-light.css">

  <link rel="stylesheet" href="/css/style.css">

  

  <script>
    window.config = {"title":"舊時光","subtitle":"About Me","description":null,"author":"COUH","language":"zh-CN","timezone":null,"url":"aboutimes.com","root":"/","permalink":":year/:month/:day/:title/","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":"README.md","new_post_name":":title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":false,"relative_link":false,"future":true,"highlight":{"enable":true,"auto_detect":false,"line_number":false,"tab_replace":null},"default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":3,"pagination_dir":"page","theme":"finemoon","deploy":{"type":"git","repo":"git@github.com:aboutimes/theme-hexo.git","branch":"master"},"ignore":[],"gitalk":"enable","gitment_id":null,"gitment_owner":"aboutimes","gitment_repo":"theme-hexo","client_id":"a4658b7937231833073e","client_secret":"ee0e478222be08062f68c03d1f6ca433c05e5209","archive":1,"category":1,"archive_generator":{"per_page":0,"yearly":true,"monthly":true,"daily":false},"category_generator":{"per_page":0},"tag_generator":{"per_page":0},"plugins":"hexo-footnotes","index_generator":{"per_page":3,"order_by":"-date"},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true,"modifyAnchors":"","autolink":true},"server":{"port":4000,"log":false,"ip":"0.0.0.0","compress":false,"header":true},"favicon":"/images/favicon.ico","menu":{"archives":"/archives","categories":"/categories","tags":"/tags"},"show_tag":true,"excerpt_link":"Read More","disqus_shortname":null,"comment":{"enable":true},"rss":"default","social":{"enable":false,"email":"dasd","instagram":"dasd","douban":"das","linkedin":"dsa","weibo":null,"stackoverflow":null,"facebook":null,"twitter":null,"github":null,"google":null,"zhihu":null,"pocket":null},"friends":{"老爹的铁铺":"https://www.26fe.cn","素錦":"http://isujin.com","寒塘渡月":"http://sometime.me","伤心凉面":"https://www.inoodle.net","MIR.":"http://mir.no/work","MODELO":"http://modelo.io","青衣十三楼":"http://scz.617.cn","1416教室":"http://1416.me","Fieldevo":"https://www.fieldevo.com/"},"since":2012,"google_analytics":null,"portfolio":null,"about":null,"poem":false};
  </script>
</head>
  <body id="web-body">
    

<header class="blog-slide">
  <nav class="blog-header">
    <a class="toggle-button mobile">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1.2em" height="1em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 1536 1280"><path d="M1536 1088v128q0 26-19 45t-45 19H64q-26 0-45-19t-19-45v-128q0-26 19-45t45-19h1408q26 0 45 19t19 45zm0-512v128q0 26-19 45t-45 19H64q-26 0-45-19T0 704V576q0-26 19-45t45-19h1408q26 0 45 19t19 45zm0-512v128q0 26-19 45t-45 19H64q-26 0-45-19T0 192V64q0-26 19-45T64 0h1408q26 0 45 19t19 45z" fill="#626262"/><rect x="0" y="0" width="1536" height="1280" fill="rgba(0, 0, 0, 0)" /></svg>
    </a>
    <ul>
      <li class="title">
        <a href="/">
          <!-- 舊時光 -->
          <svg version="1.0" xmlns="http://www.w3.org/2000/svg"
           width="128" height="40" style="margin-top: -10px;" viewBox="0 0 128 40"
           preserveAspectRatio="xMidYMid meet">
            <g transform="translate(0.000000,40.000000) scale(0.100000,-0.100000)" fill="#f5f5f5" stroke="none">
              <path d="M177 360 c3 -11 10 -23 15 -26 5 -3 1 -12 -9 -20 -17 -14 -16 -15 7
              -8 46 12 69 44 31 44 -10 0 -21 7 -25 15 -8 23 -25 18 -19 -5z"/>
              <path d="M680 335 c0 -15 -6 -25 -14 -25 -8 0 -17 -4 -21 -9 -3 -6 3 -8 15 -6
              48 9 33 -38 -23 -66 l-40 -21 7 26 c3 14 2 26 -3 26 -5 0 -9 12 -8 26 2 19 -4
              29 -22 35 -20 8 -22 7 -16 -8 18 -45 17 -52 -8 -58 -17 -5 -29 -18 -36 -37
              -16 -46 -13 -66 13 -92 12 -13 26 -31 29 -40 4 -9 13 -16 22 -16 11 0 15 12
              17 50 2 72 2 74 13 82 6 4 22 8 37 8 15 0 30 5 33 10 3 6 11 10 18 10 6 0 -7
              -18 -28 -40 -33 -34 -37 -42 -25 -51 8 -5 20 -13 26 -17 5 -4 20 -24 33 -45
              12 -20 27 -35 32 -31 5 3 9 33 9 68 0 36 5 67 12 74 10 10 10 15 -2 23 -13 8
              -12 11 4 24 29 22 6 43 -29 27 -34 -16 -33 2 3 35 18 17 23 27 14 30 -7 3 -19
              11 -26 19 -22 21 -36 17 -36 -11z m-134 -152 c-11 -11 -19 6 -11 24 8 17 8 17
              12 0 3 -10 2 -21 -1 -24z m173 -50 c0 -37 0 -38 -16 -15 -8 12 -23 22 -32 22
              -13 1 -13 3 3 15 33 25 46 18 45 -22z"/>
              <path d="M1038 313 c-3 -25 -7 -28 -39 -26 -32 2 -36 0 -32 -18 8 -29 19 -32
              48 -13 24 16 25 16 25 -9 0 -14 -11 -39 -25 -55 -35 -42 -31 -46 18 -21 l42
              21 -47 -45 c-64 -60 -63 -80 0 -23 l24 21 31 -38 c24 -28 40 -37 62 -37 31 0
              75 24 75 41 0 14 -20 11 -36 -6 -24 -24 -58 -18 -90 16 l-29 31 50 44 c45 40
              47 44 25 44 -14 0 -36 -9 -50 -20 -53 -41 -46 -17 11 37 32 31 59 60 59 65 0
              11 -37 10 -60 -2 -13 -7 -21 -6 -30 5 -18 22 -28 18 -32 -12z m62 -24 c-7 -11
              -14 -18 -17 -15 -8 8 5 36 17 36 7 0 7 -6 0 -21z"/>
              <path d="M266 302 c-3 -6 8 -12 24 -14 19 -3 29 -1 27 6 -5 14 -43 20 -51 8z"/>
              <path d="M210 276 c-6 -8 -26 -16 -43 -18 -27 -3 -29 -5 -13 -13 12 -5 26 -4
              38 4 11 7 22 10 24 8 9 -8 -8 -36 -25 -42 -10 -3 -28 -17 -41 -30 -23 -24 -23
              -26 -5 -39 17 -12 17 -14 -5 -44 -13 -18 -20 -37 -16 -47 8 -21 30 -15 34 10
              3 10 0 15 -7 11 -15 -10 -14 17 1 32 17 17 41 15 34 -3 -14 -39 35 -93 73 -80
              28 9 46 60 33 90 -13 29 -28 31 -54 8 -17 -15 -18 -15 -18 6 0 13 10 26 26 33
              24 11 24 13 8 25 -14 10 -15 15 -4 28 10 12 9 16 -5 21 -12 5 -15 14 -11 30 7
              27 -5 32 -24 10z m-9 -80 c-6 -7 -9 -20 -6 -28 7 -19 -24 -33 -39 -18 -6 6 -2
              18 14 35 24 26 51 36 31 11z m73 -92 c4 -9 4 -19 1 -22 -7 -8 -35 19 -29 29 8
              14 21 11 28 -7z m-19 -34 c3 -6 -1 -13 -10 -16 -19 -8 -30 0 -20 15 8 14 22
              14 30 1z"/>
              <path d="M50 242 c0 -5 7 -15 16 -22 12 -11 18 -10 32 5 16 17 16 17 -2 11
              -10 -3 -25 -1 -32 5 -8 7 -14 7 -14 1z"/>
            </g>
          </svg>
        </a>
      </li>
      
        
        <li class="nav-item">
          <a href="/archives" >往事</a>
        </li>
           
      
        
        <li class="nav-item">
          <a href="/categories" >记闻</a>
        </li>
           
      
        
        <li class="nav-item">
          <a href="/tags" >印象</a>
        </li>
           
      
    </ul>
  </nav>
</header>
    
<nav id="menu">
  
    
      <a href="/archives" >往事</a>
       
  
    
      <a href="/categories" >记闻</a>
       
  
    
      <a href="/tags" >印象</a>
       
  
</nav>
    
    <main class="blog-main">
      <article class="blog-post">
  

  <div class="post-content">
    <div class="post-header">
      
        
  
    <h1 class="post-title">
      <a href="/2017/10/29/2017-10-29Nginx笔记/">
        Nginx 笔记
      </a>
    </h1>
  

<div class="post-meta">
  2017-10-29
  <!-- 十月 29, 2017 -->
  
     | by COUH
  
  
</div>

      
    </div>
    <div class="post-detail">
      
        <p><img src="/images/2017-10-29-01.png" alt=""><br>　　前段时间做 Laravel 项目一直用 Apache 做 web 服务，没什么特别原因，一是就因为是系统自带，懒得折腾其他的，二是刚接触编程没多久，并不太了解其他的 web 服务器。近来开始接触到 Nginx 服务器，相对于 Apache 的稳定，Nginx 以性能见长。作为 Web 服务器：Nginx 使用更少的资源，处理请求是异步非阻塞的，支持更多的并发连接；作为反向代理服务器完成负载均衡: Nginx 既可以在内部直接支持 Rails 和 PHP 程序对外进行服务, 也可以支持作为 HTTP 代理服务器对外进行服务。<a id="more"></a></p>
<h2 id="1、Nginx-功能"><a href="#1、Nginx-功能" class="headerlink" title="1、Nginx 功能"></a>1、Nginx 功能</h2><p>Nginx 是一个高性能的 HTTP 和反向代理服务器，也是一个 IMAP / POP3 / SMTP 服务器。</p>
<h3 id="1-1、HTTP-基础功能："><a href="#1-1、HTTP-基础功能：" class="headerlink" title="1.1、HTTP 基础功能："></a>1.1、HTTP 基础功能：</h3><ul>
<li>处理静态文件，索引文件以及自动索引；</li>
<li>反向代理加速(无缓存)，简单的负载均衡和容错；</li>
<li>FastCGI，简单的负载均衡和容错；</li>
<li>模块化的结构。过滤器包括 gzipping, byte ranges, chunked responses, 以及 SSI-filter ，在 SSI 过滤器中，到同一个 proxy 或者 FastCGI 的多个子请求并发处理；</li>
<li>SSL 和 TLS SNI 支持。</li>
</ul>
<h3 id="1-2、IMAP-POP3-代理服务功能："><a href="#1-2、IMAP-POP3-代理服务功能：" class="headerlink" title="1.2、IMAP/POP3 代理服务功能："></a>1.2、IMAP/POP3 代理服务功能：</h3><ul>
<li>使用外部 HTTP 认证服务器重定向用户到 IMAP/POP3 后端；</li>
<li>使用外部 HTTP 认证服务器认证用户后连接重定向到内部的 SMTP 后端；</li>
<li>认证方法：</li>
<li>POP3: POP3 USER/PASS, APOP, AUTH LOGIN PLAIN CRAM-MD5 ；</li>
<li>IMAP: IMAP LOGIN ；</li>
<li>SMTP: AUTH LOGIN PLAIN CRAM-MD5 ；</li>
<li>SSL 支持 ；</li>
<li>在 IMAP 和 POP3 模式下的 STARTTLS 和 STLS 支持。</li>
</ul>
<h3 id="1-3、支持的操作系统："><a href="#1-3、支持的操作系统：" class="headerlink" title="1.3、支持的操作系统："></a>1.3、支持的操作系统：</h3><ul>
<li>FreeBSD 3.x, 4.x, 5.x, 6.x i386; FreeBSD 5.x, 6.x amd64 ；</li>
<li>Linux 2.2, 2.4, 2.6 i386; Linux 2.6 amd64 ；</li>
<li>Solaris 8 i386; Solaris 9 i386 and sun4u; Solaris 10 i386 ；</li>
<li>MacOS X (10.4) PPC。</li>
</ul>
<h3 id="1-4、结构与扩展："><a href="#1-4、结构与扩展：" class="headerlink" title="1.4、结构与扩展："></a>1.4、结构与扩展：</h3><p>一个主进程和多个工作进程。工作进程是单线程的，且不需要特殊授权即可运行；</p>
<ul>
<li>kqueue (FreeBSD 4.1+), epoll (Linux 2.6+), rt signals (Linux 2.2.19+), /dev/poll (Solaris 7 11/99+), select, 以及 poll 支持；</li>
<li>kqueue支持的不同功能包括 EV_CLEAR, EV_DISABLE （临时禁止事件）， NOTE_LOWAT, EV_EOF, 有效数据的数目，错误代码；</li>
<li>sendfile (FreeBSD 3.1+), sendfile (Linux 2.2+), sendfile64 (Linux 2.4.21+), 和 sendfilev (Solaris 8 7/01+) 支持；</li>
<li>输入过滤 (FreeBSD 4.1+) 以及 TCP_DEFER_ACCEPT (Linux 2.4+) 支持；</li>
<li>10,000 非活动的 HTTP keep-alive 连接仅需要 2.5M 内存；</li>
<li>最小化的数据拷贝操作。</li>
</ul>
<h3 id="1-5、其他HTTP功能："><a href="#1-5、其他HTTP功能：" class="headerlink" title="1.5、其他HTTP功能："></a>1.5、其他HTTP功能：</h3><ul>
<li>基于IP 和名称的虚拟主机服务；</li>
<li>Memcached 的 GET 接口；</li>
<li>支持 keep-alive 和管道连接；</li>
<li>灵活简单的配置；</li>
<li>重新配置和在线升级而无须中断客户的工作进程；</li>
<li>可定制的访问日志，日志写入缓存，以及快捷的日志回卷；</li>
<li>4xx-5xx 错误代码重定向；</li>
<li>基于 PCRE 的 rewrite 重写模块；</li>
<li>基于客户端 IP 地址和 HTTP 基本认证的访问控制；</li>
<li>PUT, DELETE, 和 MKCOL 方法；</li>
<li>支持 FLV （Flash 视频）；</li>
<li>带宽限制。</li>
</ul>
<h2 id="2、反向代理"><a href="#2、反向代理" class="headerlink" title="2、反向代理"></a>2、反向代理</h2><p>　　正向代理服务器，只用于代理内部网络对 Internet 的连接请求，客户机必须指定代理服务器,并将本来要直接发送到 Web 服务器上的 http 请求发送到代理服务器中。当一个代理服务器能够代理外部网络上的主机，访问内部网络时，这种代理服务的方式称为反向代理服务。</p>
<h3 id="2-1、正向代理"><a href="#2-1、正向代理" class="headerlink" title="2.1、正向代理"></a>2.1、正向代理</h3><p>　　通常来说，对于人来说可以感知到，但服务器感知不到的服务器，我们叫他正向代理服务器。比如访问 google.com 时我们需要 vpn 翻墙才能访问。<code>vpn</code> 对于<code>客户</code>来说，是可以感知到的（客户连接 vpn），<code>vpn</code> 对于<code>google 服务器</code>来说，是不可感知的(google 只知道有 http 请求过来）。<br><img src="/images/2017-10-29-02.png" alt=""></p>
<h3 id="2-2、反向代理"><a href="#2-2、反向代理" class="headerlink" title="2.2、反向代理"></a>2.2、反向代理</h3><p>　　通常来说，对于人来说不可感知，但对于服务器来说是可以感知的，我们叫他反向代理服务器，通过反向代理实现负载均衡。比如访问 baidu.com 的时候，baidu 有一个代理服务器，通过这个代理服务器，可以做负载均衡，路由到不同的 server。<code>客户</code>感知不到<code>反向代理server</code>，<code>server1 server2 server3</code>则可以感知到<code>反向代理server</code>。<br><img src="/images/2017-10-29-03.png" alt=""></p>
<h2 id="3、PHP-FPM"><a href="#3、PHP-FPM" class="headerlink" title="3、PHP-FPM"></a>3、PHP-FPM</h2><p>PHP-FPM(FastCGI Process Manager：FastCGI进程管理器)是一个PHPFastCGI管理器</p>
<h3 id="3-1、cgi、fast-cgi-协议"><a href="#3-1、cgi、fast-cgi-协议" class="headerlink" title="3.1、cgi、fast-cgi 协议"></a>3.1、cgi、fast-cgi 协议</h3><ul>
<li>cgi：为了解决不同的语言解释器(如 php、python 解释器)与 webserver 的通信，于是出现了 cgi 协议。只要你按照 cgi 协议去编写程序，就能实现语言解释器与 webwerver 的通信。如 php-cgi 程序。有了 cgi 协议，解决了 php 解释器与 webserver 通信的问题，webserver 终于可以处理动态语言了。但是，webserver每收到一个请求，都会去 fork 一个 cgi 进程，请求结束再 kill 掉这个进程。这样有 10000 个请求，就需要 fork、kill php-cgi 进程 10000 次。</li>
<li>fast-cgi：cgi 资源浪费严重，于是出现了 cgi 的改良版本，fast-cgi 。fast-cgi 每次处理完请求后，不会 kill 掉这个进程，而是保留这个进程，使这个进程可以一次处理多个请求。这样每次就不用重新 fork 一个进程了，大大提高了效率。</li>
</ul>
<h3 id="3-2、php-fpm-即-php-Fastcgi-Process-Manager"><a href="#3-2、php-fpm-即-php-Fastcgi-Process-Manager" class="headerlink" title="3.2、php-fpm 即 php-Fastcgi Process Manager"></a>3.2、php-fpm 即 php-Fastcgi Process Manager</h3><ul>
<li>php-fpm 是 FastCGI 的实现，并提供了进程管理的功能。进程包含 master 进程和 worker 进程两种进程。 </li>
<li>master 进程只有一个，负责监听端口，接收来自 Web Server 的请求，</li>
<li>worker 进程则一般有多个(具体数量根据实际需要配置)，每个进程内部都嵌入了一个 PHP 解释器，是 PHP 代码真正执行的地方。</li>
</ul>
<h2 id="4、Nginx-安装与配置"><a href="#4、Nginx-安装与配置" class="headerlink" title="4、Nginx 安装与配置"></a>4、Nginx 安装与配置</h2><h3 id="4-1、nginx-安装"><a href="#4-1、nginx-安装" class="headerlink" title="4.1、nginx 安装"></a>4.1、nginx 安装</h3><p><code>brew install nginx</code></p>
<h3 id="4-2、nginx-配置-nginx-conf"><a href="#4-2、nginx-配置-nginx-conf" class="headerlink" title="4.2、nginx 配置 nginx.conf"></a>4.2、nginx 配置 nginx.conf</h3><p>　　默认位置<code>/usr/local/etc/nginx/nginx.conf</code>，作为初级配置 <code>nginx.conf</code> 不需要更改。配置文件末尾语句<code>include servers/*</code>，包含 <code>servers</code> 文件下的子配置文件，可以对不同的项目建立不同的子配置文件。</p>
<ul>
<li>例如 larave.conf ，访问 <code>http://localhost/</code> 即可访问项目。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name localhost;</span><br><span class="line">    root /对应项目目录;</span><br><span class="line">    add_header X-Frame-Options <span class="string">"SAMEORIGIN"</span>;   </span><br><span class="line">    add_header X-XSS-Protection <span class="string">"1; mode=block"</span>; </span><br><span class="line">    add_header X-Content-Type-Options <span class="string">"nosniff"</span>; </span><br><span class="line"></span><br><span class="line">    index index.html index.htm index.php;</span><br><span class="line"></span><br><span class="line">    charset utf-8;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php?<span class="variable">$query_string</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location = /favicon.ico &#123; access_log off; log_not_found off; &#125;  </span><br><span class="line">    location = /robots.txt  &#123; access_log off; log_not_found off; &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">#error_page 404 /index.php;</span></span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_split_path_info ^(.+\.php)(/.+)$;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        fastcgi_intercept_errors on;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        include fastcgi.conf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ /\.(?!well-known).* &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;    </span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>再如 phpMyAdmin.conf ，host 文件添加 <code>127.0.0.0 phpmyadmin</code>，访问 <code>http://phpmyadmin/</code> 即可访问项目。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen 80;</span><br><span class="line">    server_name phpmyadmin;</span><br><span class="line">    root /目录路径/phpMyAdmin;</span><br><span class="line">    add_header X-Frame-Options <span class="string">"SAMEORIGIN"</span>;   </span><br><span class="line">    add_header X-XSS-Protection <span class="string">"1; mode=block"</span>; </span><br><span class="line">    add_header X-Content-Type-Options <span class="string">"nosniff"</span>; </span><br><span class="line"></span><br><span class="line">    index index.php;</span><br><span class="line"></span><br><span class="line">    charset utf-8;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        try_files <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.php?<span class="variable">$query_string</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location = /favicon.ico &#123; access_log off; log_not_found off; &#125;  </span><br><span class="line">    location = /robots.txt  &#123; access_log off; log_not_found off; &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="comment">#error_page 404 /index.php;</span></span><br><span class="line"></span><br><span class="line">    location ~ \.php$ &#123;</span><br><span class="line">        fastcgi_split_path_info ^(.+\.php)(/.+)$;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_index index.php;</span><br><span class="line">        fastcgi_intercept_errors on;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        include fastcgi.conf;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    location ~ /\.(?!well-known).* &#123;</span><br><span class="line">        deny all;</span><br><span class="line">    &#125;      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="4-3、php-fpm-配置-php-fpm-conf"><a href="#4-3、php-fpm-配置-php-fpm-conf" class="headerlink" title="4.3、php-fpm 配置 php-fpm.conf"></a>4.3、php-fpm 配置 php-fpm.conf</h3><ul>
<li>默认位置<code>/private/etc/php-fpm.conf</code>，默认没有配置文件，需要将 <code>php-fpm.conf.</code> 重命名为 <code>php-fpm.conf</code> 。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">;去掉 pid 和 erro 的注释，修改文件位置到 <span class="built_in">local</span> 目录，避免权限问题。</span><br><span class="line">[global]</span><br><span class="line">; Pid file</span><br><span class="line">; Note: the default prefix is /usr/var</span><br><span class="line">; Default Value: none</span><br><span class="line"> pid = /usr/<span class="built_in">local</span>/var/run/php-fpm.pid</span><br><span class="line"></span><br><span class="line">; Error <span class="built_in">log</span> file</span><br><span class="line">; If it<span class="string">'s set to "syslog", log is sent to syslogd instead of being written</span></span><br><span class="line"><span class="string">; into a local file.</span></span><br><span class="line"><span class="string">; Note: the default prefix is /usr/var</span></span><br><span class="line"><span class="string">; Default Value: log/php-fpm.log</span></span><br><span class="line"><span class="string"> error_log = /usr/local/var/run/php-fpm.log</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>/private/etc/php-fpm.d/www.conf.default</code> 重命名为 <code>www.conf</code></li>
</ul>
<p>　　至此配置完成，访问 <code>http://localhost:8098</code> 即可访问数据库。nginx 的优势是处理静态请求，cpu内存使用率低，可以反向代理隐藏主机 IP，apache 适合处理动态请求，所以现在一般前端用 nginx 作为反向代理抗住压力，apache 作为后端处理动态请求。</p>
<h2 id="5、常用命令"><a href="#5、常用命令" class="headerlink" title="5、常用命令"></a>5、常用命令</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">nginx -s stop </span><br><span class="line"><span class="comment">#快速关闭Nginx，可能不保存相关信息，并迅速终止web服务。</span></span><br><span class="line">nginx -s quit</span><br><span class="line"><span class="comment">#平稳关闭Nginx，保存相关信息，有安排的结束web服务。</span></span><br><span class="line">nginx -s reload</span><br><span class="line"><span class="comment">#因改变了Nginx相关配置，需要重新加载配置而重载。</span></span><br><span class="line">nginx -s reopen</span><br><span class="line"><span class="comment">#重新打开日志文件。</span></span><br><span class="line">nginx -c filename</span><br><span class="line"><span class="comment">#为 Nginx 指定一个配置文件，来代替缺省的。</span></span><br><span class="line">nginx -t</span><br><span class="line"><span class="comment">#不运行，而仅仅测试配置文件。nginx 将检查配置文件的语法的正确性，并尝试打开配置文件中所引用到的文件。</span></span><br><span class="line">nginx -v</span><br><span class="line"><span class="comment">#显示 nginx 的版本。</span></span><br><span class="line">nginx -V</span><br><span class="line"><span class="comment">#显示 nginx 的版本，编译器版本和配置参数。</span></span><br></pre></td></tr></table></figure>
<h2 id="6、http-反向代理配置"><a href="#6、http-反向代理配置" class="headerlink" title="6、http 反向代理配置"></a>6、http 反向代理配置</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#运行用户</span></span><br><span class="line"><span class="comment">#user somebody;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动进程,通常设置成和cpu的数量相等</span></span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line"><span class="comment">#全局错误日志</span></span><br><span class="line">error_log  D:/Tools/nginx-1.10.1/logs/error.log;</span><br><span class="line">error_log  D:/Tools/nginx-1.10.1/logs/notice.log  notice;</span><br><span class="line">error_log  D:/Tools/nginx-1.10.1/logs/info.log  info;</span><br><span class="line"></span><br><span class="line"><span class="comment">#PID文件，记录当前启动的nginx的进程ID</span></span><br><span class="line">pid        D:/Tools/nginx-1.10.1/logs/nginx.pid;</span><br><span class="line"></span><br><span class="line"><span class="comment">#工作模式及连接数上限</span></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;    <span class="comment">#单个后台worker process进程的最大并发链接数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#设定http服务器，利用它的反向代理功能提供负载均衡支持</span></span><br><span class="line">http &#123;</span><br><span class="line">    <span class="comment">#设定mime类型(邮件支持类型),类型由mime.types文件定义</span></span><br><span class="line">    include       D:/Tools/nginx-1.10.1/conf/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#设定日志</span></span><br><span class="line">    log_format  main  <span class="string">'[$remote_addr] - [$remote_user] [$time_local] "$request" '</span></span><br><span class="line">                      <span class="string">'$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">                      <span class="string">'"$http_user_agent" "$http_x_forwarded_for"'</span>;</span><br><span class="line"></span><br><span class="line">    access_log    D:/Tools/nginx-1.10.1/logs/access.log main;</span><br><span class="line">    rewrite_log     on;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#sendfile 指令指定 nginx 是否调用 sendfile 函数（zero copy 方式）来输出文件，对于普通应用，</span></span><br><span class="line">    <span class="comment">#必须设为 on,如果用来进行下载等应用磁盘IO重负载应用，可设置为 off，以平衡磁盘与网络I/O处理速度，降低系统的uptime.</span></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#连接超时时间</span></span><br><span class="line">    keepalive_timeout  120;</span><br><span class="line">    tcp_nodelay        on;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip压缩开关</span></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#设定实际的服务器列表</span></span><br><span class="line">    upstream zp_server1&#123;</span><br><span class="line">        server 127.0.0.1:8089;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#HTTP服务器</span></span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="comment">#监听80端口，80端口是知名端口号，用于HTTP协议</span></span><br><span class="line">        listen       80;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#定义使用www.xx.com访问</span></span><br><span class="line">        server_name  www.helloworld.com;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#首页</span></span><br><span class="line">        index index.html</span><br><span class="line"></span><br><span class="line">        <span class="comment">#指向webapp的目录</span></span><br><span class="line">        root D:\01_Workspace\Project\github\zp\SpringNotes\spring-security\spring-shiro\src\main\webapp;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#编码格式</span></span><br><span class="line">        charset utf-8;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#代理配置参数</span></span><br><span class="line">        proxy_connect_timeout 180;</span><br><span class="line">        proxy_send_timeout 180;</span><br><span class="line">        proxy_read_timeout 180;</span><br><span class="line">        proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">        proxy_set_header X-Forwarder-For <span class="variable">$remote_addr</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#反向代理的路径（和upstream绑定），location 后面设置映射的路径</span></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://zp_server1;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#静态文件，nginx自己处理</span></span><br><span class="line">        location ~ ^/(images|javascript|js|css|flash|media|static)/ &#123;</span><br><span class="line">            root D:\01_Workspace\Project\github\zp\SpringNotes\spring-security\spring-shiro\src\main\webapp\views;</span><br><span class="line">            <span class="comment">#过期30天，静态文件不怎么更新，过期可以设大一点，如果频繁更新，则可以设置得小一点。</span></span><br><span class="line">            expires 30d;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#设定查看Nginx状态的地址</span></span><br><span class="line">        location /NginxStatus &#123;</span><br><span class="line">            stub_status           on;</span><br><span class="line">            access_log            on;</span><br><span class="line">            auth_basic            <span class="string">"NginxStatus"</span>;</span><br><span class="line">            auth_basic_user_file  conf/htpasswd;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#禁止访问 .htxxx 文件</span></span><br><span class="line">        location ~ /\.ht &#123;</span><br><span class="line">            deny all;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#错误处理页面（可选择性配置）</span></span><br><span class="line">        <span class="comment">#error_page   404              /404.html;</span></span><br><span class="line">        <span class="comment">#error_page   500 502 503 504  /50x.html;</span></span><br><span class="line">        <span class="comment">#location = /50x.html &#123;</span></span><br><span class="line">        <span class="comment">#    root   html;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="7、负载均衡配置"><a href="#7、负载均衡配置" class="headerlink" title="7、负载均衡配置"></a>7、负载均衡配置</h2><p>　　假设这样一个应用场景：将应用部署在 192.168.1.11:80、192.168.1.12:80、192.168.1.13:80 三台 linux 环境的服务器上。网站域名叫 <a href="http://www.helloworld.com，公网" target="_blank" rel="noopener">www.helloworld.com，公网</a> IP 为 192.168.1.11。在公网 IP 所在的服务器上部署 nginx，对所有请求做负载均衡处理。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">     <span class="comment">#设定mime类型,类型由mime.type文件定义</span></span><br><span class="line">    include       /etc/nginx/mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    <span class="comment">#设定日志格式</span></span><br><span class="line">    access_log    /var/<span class="built_in">log</span>/nginx/access.log;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#设定负载均衡的服务器列表</span></span><br><span class="line">    upstream load_balance_server &#123;</span><br><span class="line">        <span class="comment">#weigth参数表示权值，权值越高被分配到的几率越大</span></span><br><span class="line">        server 192.168.1.11:80   weight=5;</span><br><span class="line">        server 192.168.1.12:80   weight=1;</span><br><span class="line">        server 192.168.1.13:80   weight=6;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">#HTTP服务器</span></span><br><span class="line">   server &#123;</span><br><span class="line">        <span class="comment">#侦听80端口</span></span><br><span class="line">        listen       80;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#定义使用www.xx.com访问</span></span><br><span class="line">        server_name  www.helloworld.com;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#对所有请求进行负载均衡请求</span></span><br><span class="line">        location / &#123;</span><br><span class="line">            root        /root;                 <span class="comment">#定义服务器的默认网站根目录位置</span></span><br><span class="line">            index       index.html index.htm;  <span class="comment">#定义首页索引文件的名称</span></span><br><span class="line">            proxy_pass  http://load_balance_server ;<span class="comment">#请求转向load_balance_server 定义的服务器列表</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">#以下是一些反向代理的配置(可选择性配置)</span></span><br><span class="line">            <span class="comment">#proxy_redirect off;</span></span><br><span class="line">            proxy_set_header Host <span class="variable">$host</span>;</span><br><span class="line">            proxy_set_header X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="comment">#后端的Web服务器可以通过X-Forwarded-For获取用户真实IP</span></span><br><span class="line">            proxy_set_header X-Forwarded-For <span class="variable">$remote_addr</span>;</span><br><span class="line">            proxy_connect_timeout 90;          <span class="comment">#nginx跟后端服务器连接超时时间(代理连接超时)</span></span><br><span class="line">            proxy_send_timeout 90;             <span class="comment">#后端服务器数据回传时间(代理发送超时)</span></span><br><span class="line">            proxy_read_timeout 90;             <span class="comment">#连接成功后，后端服务器响应时间(代理接收超时)</span></span><br><span class="line">            proxy_buffer_size 4k;              <span class="comment">#设置代理服务器（nginx）保存用户头信息的缓冲区大小</span></span><br><span class="line">            proxy_buffers 4 32k;               <span class="comment">#proxy_buffers缓冲区，网页平均在32k以下的话，这样设置</span></span><br><span class="line">            proxy_busy_buffers_size 64k;       <span class="comment">#高负荷下缓冲大小（proxy_buffers*2）</span></span><br><span class="line">            proxy_temp_file_write_size 64k;    <span class="comment">#设定缓存文件夹大小，大于这个值，将从upstream服务器传</span></span><br><span class="line"></span><br><span class="line">            client_max_body_size 10m;          <span class="comment">#允许客户端请求的最大单文件字节数</span></span><br><span class="line">            client_body_buffer_size 128k;      <span class="comment">#缓冲区代理缓冲用户端请求的最大字节数</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="8、网站有多个-webapp-的配置"><a href="#8、网站有多个-webapp-的配置" class="headerlink" title="8、网站有多个 webapp 的配置"></a>8、网站有多个 webapp 的配置</h2><p>　　举个例子：假如 <code>www.helloworld.com</code> 站点有好几个 webapp，finance（金融）、product（产品）、admin（用户中心）。访问这些应用的方式通过上下文(context)来进行区分:</p>
<ul>
<li><code>www.helloworld.com/finance/</code></li>
<li><code>www.helloworld.com/product/</code></li>
<li><code>www.helloworld.com/admin/</code></li>
</ul>
<p>　　我们知道，http 的默认端口号是 80，如果在一台服务器上同时启动这 3 个 webapp 应用，都用 80 端口，肯定是不成的。所以，这三个应用需要分别绑定不同的端口号。那么，问题来了，用户在实际访问 <code>www.helloworld.com</code> 站点时，访问不同 webapp，总不会还带着对应的端口号去访问吧。所以，你再次需要用到反向代理来做处理。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">http &#123;</span><br><span class="line">    <span class="comment">#此处省略一些基本配置</span></span><br><span class="line"></span><br><span class="line">    upstream product_server&#123;</span><br><span class="line">        server www.helloworld.com:8081;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    upstream admin_server&#123;</span><br><span class="line">        server www.helloworld.com:8082;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    upstream finance_server&#123;</span><br><span class="line">        server www.helloworld.com:8083;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        <span class="comment">#此处省略一些基本配置</span></span><br><span class="line">        <span class="comment">#默认指向product的server</span></span><br><span class="line">        location / &#123;</span><br><span class="line">            proxy_pass http://product_server;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /product/&#123;</span><br><span class="line">            proxy_pass http://product_server;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /admin/ &#123;</span><br><span class="line">            proxy_pass http://admin_server;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        location /finance/ &#123;</span><br><span class="line">            proxy_pass http://finance_server;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="9、https-反向代理配置"><a href="#9、https-反向代理配置" class="headerlink" title="9、https 反向代理配置"></a>9、https 反向代理配置</h2><ul>
<li>HTTPS 的固定端口号是 443，不同于 HTTP 的 80 端口</li>
<li>SSL 标准需要引入安全证书，所以在 nginx.conf 中你需要指定证书和它对应的 key</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#其他和 http 反向代理基本一样，只是在 Server 部分配置有些不同。</span></span><br><span class="line"><span class="comment">#HTTP服务器</span></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="comment">#监听443端口。443为知名端口号，主要用于HTTPS协议</span></span><br><span class="line">    listen       443 ssl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#定义使用www.xx.com访问</span></span><br><span class="line">    server_name  www.helloworld.com;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#ssl证书文件位置(常见证书文件格式为：crt/pem)</span></span><br><span class="line">    ssl_certificate      cert.pem;</span><br><span class="line">    <span class="comment">#ssl证书key位置</span></span><br><span class="line">    ssl_certificate_key  cert.key;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#ssl配置参数（选择性配置）</span></span><br><span class="line">    ssl_session_cache    shared:SSL:1m;</span><br><span class="line">    ssl_session_timeout  5m;</span><br><span class="line">    <span class="comment">#数字签名，此处使用MD5</span></span><br><span class="line">    ssl_ciphers  HIGH:!aNULL:!MD5;</span><br><span class="line">    ssl_prefer_server_ciphers  on;</span><br><span class="line"></span><br><span class="line">    location / &#123;</span><br><span class="line">        root   /root;</span><br><span class="line">        index  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="10、静态站点配置"><a href="#10、静态站点配置" class="headerlink" title="10、静态站点配置"></a>10、静态站点配置</h2><p>　　如果所有的静态资源都放在了 /app/dist 目录下，我们只需要在 nginx.conf 中指定首页以及这个站点的 host 即可，配置如下：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line">    sendfile        on;</span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    gzip on;</span><br><span class="line">    gzip_types text/plain application/x-javascript text/css application/xml text/javascript application/javascript image/jpeg image/gif image/png;</span><br><span class="line">    gzip_vary on;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  static.zp.cn;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root /app/dist;</span><br><span class="line">            index index.html;</span><br><span class="line">            <span class="comment">#转发任何请求到 index.html</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="11、搭建文件服务器"><a href="#11、搭建文件服务器" class="headerlink" title="11、搭建文件服务器"></a>11、搭建文件服务器</h2><ul>
<li>将 autoindex 开启可以显示目录，默认不开启。</li>
<li>将 autoindex_exact_size 开启可以显示文件的大小。</li>
<li>将 autoindex_localtime 开启可以显示文件的修改时间。</li>
<li>root 用来设置开放为文件服务的根路径。</li>
<li>charset 设置为 charset utf-8,gbk;，可以避免中文乱码问题（windows 服务器下设置后，依然乱码，本人暂时没有找到解决方法）。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">autoindex on;<span class="comment"># 显示目录</span></span><br><span class="line">autoindex_exact_size on;<span class="comment"># 显示文件大小</span></span><br><span class="line">autoindex_localtime on;<span class="comment"># 显示文件时间</span></span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    charset      utf-8,gbk; <span class="comment"># windows 服务器下设置后，依然乱码，暂时无解</span></span><br><span class="line">    listen       9050 default_server;</span><br><span class="line">    listen       [::]:9050 default_server;</span><br><span class="line">    server_name  _;</span><br><span class="line">    root         /share/fs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="12、跨域解决方案"><a href="#12、跨域解决方案" class="headerlink" title="12、跨域解决方案"></a>12、跨域解决方案</h2><p>　　web 领域开发中，经常采用前后端分离模式。这种模式下，前端和后端分别是独立的 web 应用程序，例如：后端是 Java 程序，前端是 React 或 Vue 应用。各自独立的 web app 在互相访问时，势必存在跨域问题。解决跨域问题一般有两种思路：</p>
<ul>
<li>CORS 在后端服务器设置 HTTP 响应头，把你需要运行访问的域名加入加入 Access-Control-Allow-Origin 中。</li>
<li>jsonp 把后端根据请求，构造 json 数据，并返回，前端用 jsonp 跨域。</li>
</ul>
<p>　　nginx 根据第一种思路，也提供了一种解决跨域的解决方案。举例：<code>www.helloworld.com</code> 网站是由一个前端 app ，一个后端 app 组成的。前端端口号为 9000， 后端端口号为 8080。前端和后端如果使用 http 进行交互时，请求会被拒绝，因为存在跨域问题。</p>
<ul>
<li>首先，在 enable-cors.conf 文件中设置 cors ：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># allow origin list</span></span><br><span class="line"><span class="built_in">set</span> <span class="variable">$ACAO</span> <span class="string">'*'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># set single origin</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$http_origin</span> ~* (www.helloworld.com)$) &#123;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$ACAO</span> <span class="variable">$http_origin</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$cors</span> = <span class="string">"trueget"</span>) &#123;</span><br><span class="line">    add_header <span class="string">'Access-Control-Allow-Origin'</span> <span class="string">"<span class="variable">$http_origin</span>"</span>;</span><br><span class="line">    add_header <span class="string">'Access-Control-Allow-Credentials'</span> <span class="string">'true'</span>;</span><br><span class="line">    add_header <span class="string">'Access-Control-Allow-Methods'</span> <span class="string">'GET, POST, OPTIONS'</span>;</span><br><span class="line">    add_header <span class="string">'Access-Control-Allow-Headers'</span> <span class="string">'DNT,X-Mx-ReqToken,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_method</span> = <span class="string">'OPTIONS'</span>) &#123;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$cors</span> <span class="string">"<span class="variable">$&#123;cors&#125;</span>options"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_method</span> = <span class="string">'GET'</span>) &#123;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$cors</span> <span class="string">"<span class="variable">$&#123;cors&#125;</span>get"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$request_method</span> = <span class="string">'POST'</span>) &#123;</span><br><span class="line">  <span class="built_in">set</span> <span class="variable">$cors</span> <span class="string">"<span class="variable">$&#123;cors&#125;</span>post"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>接下来，在你的服务器中 include enable-cors.conf 来引入跨域配置：</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># ----------------------------------------------------</span></span><br><span class="line"><span class="comment"># 此文件为项目 nginx 配置片段</span></span><br><span class="line"><span class="comment"># 可以直接在 nginx config 中 include（推荐）</span></span><br><span class="line"><span class="comment"># 或者 copy 到现有 nginx 中，自行配置</span></span><br><span class="line"><span class="comment"># www.helloworld.com 域名需配合 dns hosts 进行配置</span></span><br><span class="line"><span class="comment"># 其中，api 开启了 cors，需配合本目录下另一份配置文件</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------</span></span><br><span class="line">upstream front_server&#123;</span><br><span class="line">  server www.helloworld.com:9000;</span><br><span class="line">&#125;</span><br><span class="line">upstream api_server&#123;</span><br><span class="line">  server www.helloworld.com:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">  listen       80;</span><br><span class="line">  server_name  www.helloworld.com;</span><br><span class="line"></span><br><span class="line">  location ~ ^/api/ &#123;</span><br><span class="line">    include <span class="built_in">enable</span>-cors.conf;</span><br><span class="line">    proxy_pass http://api_server;</span><br><span class="line">    rewrite <span class="string">"^/api/(.*)$"</span> /<span class="variable">$1</span> <span class="built_in">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  location ~ ^/ &#123;</span><br><span class="line">    proxy_pass http://front_server;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

        <hr>
      
    </div>

    
      
    

    
      
    

    
      
  
  
  <div class="post-tags">
    <a href="/tags/Nginx/"><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="1em" height="1em" fill="#ccc" style="-ms-transform: rotate(360deg) translate(-2px, 3px); -webkit-transform: rotate(360deg) translate(-2px, 3px); transform: rotate(360deg) translate(-2px, 3px);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 32 32"><path d="M18.52 30a3 3 0 0 1-2.12-.88L2.88 15.61A3 3 0 0 1 2 13.49V5a3 3 0 0 1 3-3h8.49a3 3 0 0 1 2.12.88l13.51 13.51a3 3 0 0 1 0 4.25l-8.48 8.48a3 3 0 0 1-2.12.88zM5 4a1 1 0 0 0-1 1v8.49a1 1 0 0 0 .3.71l13.51 13.51a1 1 0 0 0 1.41 0l8.49-8.49a1 1 0 0 0 0-1.41L14.2 4.3a1 1 0 0 0-.71-.3H5z" /><path d="M10 14a4 4 0 1 1 4-4a4 4 0 0 1-4 4zm0-6a2 2 0 1 0 2 2a2 2 0 0 0-2-2z" /><rect x="0" y="0" width="32" height="32" fill="rgba(0, 0, 0, 0)" /></svg>Nginx</a>
  </div>
  <hr>
  

      <div class="post-more">
  
    <div class="post-pre">
      <span>下一篇</span>
      <a href="/2017/12/31/2017-12-31Apace虚拟主机配置/">Apace 虚拟主机配置</a>
    </div>
  
  
  <div class="post-next">
    <span>上一篇</span>
    <a href="/2017/10/12/2017-10-12RESTfulAPI/">RESTful API</a>
  </div>
  
</div>
      <div class="comments" id="comments">
    <div id="showtalk">查看评论</div>
    <div id="container"></div>
    <script>
      var showtalk = document.getElementById("showtalk");
      var container = document.getElementById("container");
      var status = true;
      window.onload=function (){
        if (typeof Gitment!='function') {// 如果未缓存，加载 js 和 css
          let link = document.createElement('link');
          let heads = document.getElementsByTagName("head"); 
          link.setAttribute("rel", "stylesheet"); 
          link.setAttribute("type", "text/css"); 
          link.setAttribute("href", '/css/gitment.css'); 
          if(heads.length){
            heads[0].appendChild(link);
          }else {
            document.documentElement.appendChild(link);
          } 
              
          let script = document.createElement('script');
          script.type = 'text/javascript';
          script.src = '/js/gitment.js'; //填自己的js路径
          document.body.appendChild(script);
        }
      }
      showtalk.onclick=function(){
        if (status == 'true') {
          var gitment = new Gitment({
            id: document.title, 
            owner: config.gitment_owner,
            repo: config.gitment_repo,
            oauth: {
              client_id: config.client_id,
              client_secret: config.client_secret,
            },
          });
          status = false;
          gitment.render('container');
          showtalk.innerHTML = '收起评论';
        }else {
          status = true;
          container.innerHTML = '';
          showtalk.innerHTML = '查看评论';
        }
      };
    </script>
  </div>
    
  </div>
</article>

    </main>
    
    <div class="back-to-top" id="back-to-top">
      <svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" focusable="false" width="2em" height="2em" style="-ms-transform: rotate(360deg); -webkit-transform: rotate(360deg); transform: rotate(360deg);" preserveAspectRatio="xMidYMid meet" viewBox="0 0 512 512"><path d="M8 256C8 119 119 8 256 8s248 111 248 248s-111 248-248 248S8 393 8 256zm292 116V256h70.9c10.7 0 16.1-13 8.5-20.5L264.5 121.2c-4.7-4.7-12.2-4.7-16.9 0l-115 114.3c-7.6 7.6-2.2 20.5 8.5 20.5H212v116c0 6.6 5.4 12 12 12h64c6.6 0 12-5.4 12-12z" fill="#999"></path></svg>
    </div>

    <footer class="blog-footer">
  


<!-- <hr> -->
<div class="blog-footer-friends">
<!--   <p class="title">FRIENDS</p> -->
  <div class="friends">
  
    <a href="https://www.26fe.cn" target="_blank">老爹的铁铺</a>
  
    <a href="http://isujin.com" target="_blank">素錦</a>
  
    <a href="http://sometime.me" target="_blank">寒塘渡月</a>
  
    <a href="https://www.inoodle.net" target="_blank">伤心凉面</a>
  
    <a href="http://mir.no/work" target="_blank">MIR.</a>
  
    <a href="http://modelo.io" target="_blank">MODELO</a>
  
    <a href="http://scz.617.cn" target="_blank">青衣十三楼</a>
  
    <a href="http://1416.me" target="_blank">1416教室</a>
  
    <a href="https://www.fieldevo.com/" target="_blank">Fieldevo</a>
  
  </div>
</div>

  
 
  <div class="blog-footer-copyright">
  <p class="copyright">Copyright &#169; 2012-2020 COUH. All rights reserved</p>
</div>
</footer>


<!--  -->




<script type="text/javascript" src="/js/main.js"></script>
  </body>
</html>